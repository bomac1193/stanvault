generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// User (Artist)
model User {
  id                   String               @id @default(cuid())
  email                String               @unique
  emailVerified        DateTime?
  password             String?
  name                 String?
  image                String?
  artistName           String?
  genre                String?
  careerStage          CareerStage?
  location             String?
  spotifyArtistId      String?              // Artist's Spotify ID for matching listeners
  spotifyArtistUri     String?              // Spotify URI
  onboardingCompleted  Boolean              @default(false)
  onboardingStep       Int                  @default(1)
  isPublicProfile      Boolean              @default(false)  // Opt-in for public SCR profile
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  accounts             Account[]
  sessions             Session[]
  platformConnections  PlatformConnection[]
  fans                 Fan[]
  metricsHistory       ArtistMetricsHistory[]
  fanUserLinks         FanUserArtistLink[]  // Fan portal users who are fans of this artist
}

enum CareerStage {
  EMERGING
  GROWING
  ESTABLISHED
  VETERAN
}

// Platform Connection
model PlatformConnection {
  id              String           @id @default(cuid())
  userId          String
  platform        Platform
  accessToken     String?          @db.Text
  refreshToken    String?          @db.Text
  tokenExpiresAt  DateTime?        // When access token expires
  platformUserId  String?          // User's ID on the platform
  platformScope   String?          // Granted OAuth scopes
  status          ConnectionStatus @default(CONNECTED)
  lastSyncAt      DateTime?
  fanCount        Int              @default(0)
  syncError       String?          // Last sync error message
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
}

enum Platform {
  SPOTIFY
  INSTAGRAM
  TIKTOK
  YOUTUBE
  TWITTER
  EMAIL
}

enum ConnectionStatus {
  CONNECTED
  EXPIRED
  ERROR
  DISCONNECTED
}

// Fan
model Fan {
  id              String           @id @default(cuid())
  userId          String
  displayName     String
  email           String?
  avatarUrl       String?
  location        String?
  city            String?
  country         String?
  stanScore       Int              @default(0)
  tier            FanTier          @default(CASUAL)
  platformScore   Int              @default(0)
  engagementScore Int              @default(0)
  longevityScore  Int              @default(0)
  recencyScore    Int              @default(0)
  firstSeenAt     DateTime         @default(now())
  lastActiveAt    DateTime         @default(now())
  notes           String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  platformLinks FanPlatformLink[]
  events        FanEvent[]
  snapshots     FanSnapshot[]
  listeningEvents ListeningEvent[]
  fanUserLink   FanUserArtistLink?  // Link to fan portal user if claimed

  @@index([userId, stanScore])
  @@index([userId, tier])
  @@index([userId, lastActiveAt])
  @@index([userId, firstSeenAt])
}

enum FanTier {
  CASUAL
  ENGAGED
  DEDICATED
  SUPERFAN
}

// Fan Platform Link - platform-specific metrics
model FanPlatformLink {
  id            String   @id @default(cuid())
  fanId         String
  platform      Platform
  platformFanId String?

  // Spotify metrics
  streams       Int?
  playlistAdds  Int?
  saves         Int?

  // Social metrics (Instagram, TikTok, Twitter)
  follows       Boolean?
  likes         Int?
  comments      Int?
  shares        Int?

  // YouTube metrics
  subscribed    Boolean?
  videoViews    Int?
  watchTime     Int?

  // Email metrics
  emailOpens    Int?
  emailClicks   Int?

  firstSeenAt   DateTime @default(now())
  lastActiveAt  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  fan Fan @relation(fields: [fanId], references: [id], onDelete: Cascade)

  @@unique([fanId, platform])
}

// Fan Event (Journey tracking)
model FanEvent {
  id          String    @id @default(cuid())
  fanId       String
  eventType   EventType
  platform    Platform?
  description String?
  metadata    Json?
  occurredAt  DateTime  @default(now())
  createdAt   DateTime  @default(now())

  fan Fan @relation(fields: [fanId], references: [id], onDelete: Cascade)

  @@index([fanId, occurredAt])
}

enum EventType {
  FIRST_STREAM
  FIRST_FOLLOW
  FIRST_LIKE
  FIRST_COMMENT
  FIRST_SHARE
  PLAYLIST_ADD
  EMAIL_SUBSCRIBE
  EMAIL_OPEN
  TIER_UPGRADE
  TIER_DOWNGRADE
  BECAME_SUPERFAN
  WENT_DORMANT
  REACTIVATED
  MILESTONE_STREAMS
  MILESTONE_ENGAGEMENT
}

// Fan Snapshot - Daily snapshots for hold rate calculation
model FanSnapshot {
  id        String   @id @default(cuid())
  fanId     String
  date      DateTime @db.Date
  stanScore Int
  tier      FanTier
  isActive  Boolean  @default(true)  // Was fan active when snapshot taken?
  createdAt DateTime @default(now())

  fan Fan @relation(fields: [fanId], references: [id], onDelete: Cascade)

  @@unique([fanId, date])
  @@index([fanId, date])
  @@index([date])
}

// Artist Metrics History - SCR and other metrics over time
model ArtistMetricsHistory {
  id                    String   @id @default(cuid())
  userId                String
  date                  DateTime @db.Date

  // Fan counts
  totalFans             Int
  casualCount           Int
  engagedCount          Int
  dedicatedCount        Int
  superfanCount         Int

  // SCR Components
  holdRate90Day         Float?   // % retained after 90 days
  holdRate30Day         Float?   // % retained after 30 days
  depthVelocity         Float?   // Normalized time to superfan (0-1)
  platformIndependence  Float?   // 1 - HHI (0-1)
  churnRate             Float?   // % regressed or dormant

  // Calculated SCR
  scr                   Float?   // Stan Conversion Rate

  // Additional metrics
  avgStanScore          Float?
  newFansCount          Int?     // New fans this period
  churnedFansCount      Int?     // Fans lost this period
  upgradedFansCount     Int?     // Fans who upgraded tier

  createdAt             DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

// Listening Event - Detailed streaming history from Spotify
model ListeningEvent {
  id           String   @id @default(cuid())
  fanId        String
  trackId      String   // Spotify track ID
  trackName    String
  artistId     String   // Artist's Spotify ID
  artistName   String
  albumId      String?
  albumName    String?
  playedAt     DateTime
  durationMs   Int      // How long they listened
  contextType  String?  // album, playlist, artist, etc.
  contextUri   String?  // URI of the context
  createdAt    DateTime @default(now())

  fan Fan @relation(fields: [fanId], references: [id], onDelete: Cascade)

  @@index([fanId, playedAt])
  @@index([artistId, playedAt])
  @@index([trackId])
}

// Fan Verification Token - For the verification protocol (artist-issued)
model FanVerificationToken {
  id              String    @id @default(cuid())
  fanId           String
  artistId        String    // The artist this verification is for
  token           String    @unique
  tier            FanTier
  stanScore       Int
  relationshipMonths Int
  issuedAt        DateTime  @default(now())
  expiresAt       DateTime
  revokedAt       DateTime?
  usageCount      Int       @default(0)
  lastUsedAt      DateTime?

  // Metadata
  issuedFor       String?   // Purpose/recipient of the token

  createdAt       DateTime  @default(now())

  @@index([fanId])
  @@index([token])
  @@index([expiresAt])
}

// ============================================
// FAN PORTAL - Two-sided marketplace models
// ============================================

// FanUser - A fan with their own account (the other side of the marketplace)
model FanUser {
  id                    String    @id @default(cuid())
  email                 String    @unique
  password              String?
  displayName           String
  avatarUrl             String?

  // Spotify connection for verification
  spotifyUserId         String?   @unique
  spotifyAccessToken    String?   @db.Text
  spotifyRefreshToken   String?   @db.Text
  spotifyTokenExpiresAt DateTime?

  // Profile data
  country               String?

  // Onboarding
  onboardingCompleted   Boolean   @default(false)
  onboardingStep        Int       @default(1)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  artistRelationships   FanUserArtistLink[]
  verificationTokens    FanUserVerificationToken[]
  sessions              FanUserSession[]

  @@index([email])
  @@index([spotifyUserId])
}

// FanUserSession - Separate session management for fan portal
model FanUserSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  fanUserId    String
  expires      DateTime

  fanUser FanUser @relation(fields: [fanUserId], references: [id], onDelete: Cascade)

  @@index([fanUserId])
}

// FanUserArtistLink - The relationship between a fan and an artist
// This is the core of the two-sided marketplace
model FanUserArtistLink {
  id            String    @id @default(cuid())
  fanUserId     String
  artistId      String    // User.id (the artist)
  fanRecordId   String?   @unique  // Link to existing Fan record if matched

  // Cached relationship data (computed from listening history)
  tier          FanTier   @default(CASUAL)
  stanScore     Int       @default(0)
  totalStreams  Int       @default(0)
  savedTracks   Int       @default(0)
  playlistAdds  Int       @default(0)
  isFollowing   Boolean   @default(false)

  firstSeenAt   DateTime  @default(now())
  lastActiveAt  DateTime  @default(now())

  // Verification status
  verified      Boolean   @default(false)  // Has this relationship been verified via Spotify?
  verifiedAt    DateTime?
  verifiedVia   String?   // "spotify", "manual", etc.

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  fanUser       FanUser   @relation(fields: [fanUserId], references: [id], onDelete: Cascade)
  artist        User      @relation(fields: [artistId], references: [id], onDelete: Cascade)
  fanRecord     Fan?      @relation(fields: [fanRecordId], references: [id])

  @@unique([fanUserId, artistId])
  @@index([fanUserId])
  @@index([artistId])
  @@index([tier])
}

// FanUserVerificationToken - Fan-initiated verification tokens
// Different from FanVerificationToken (artist-issued) - this is self-service
model FanUserVerificationToken {
  id                 String    @id @default(cuid())
  fanUserId          String
  artistId           String    // Which artist relationship this proves
  token              String    @unique

  // Snapshot of status at time of issuance
  tier               FanTier
  stanScore          Int
  relationshipMonths Int

  // Token lifecycle
  issuedAt           DateTime  @default(now())
  expiresAt          DateTime
  revokedAt          DateTime?

  // Usage tracking
  usageCount         Int       @default(0)
  lastUsedAt         DateTime?

  // What the fan is using it for (optional)
  purpose            String?

  createdAt          DateTime  @default(now())

  fanUser FanUser @relation(fields: [fanUserId], references: [id], onDelete: Cascade)

  @@index([fanUserId])
  @@index([artistId])
  @@index([token])
  @@index([expiresAt])
}

// FanIdentityExport - Track when fans export their portable identity
model FanIdentityExport {
  id          String   @id @default(cuid())
  fanUserId   String
  format      String   // "json", "signed_json"
  signature   String?  // Cryptographic signature for authenticity
  exportedAt  DateTime @default(now())

  // Snapshot of what was exported
  artistCount Int
  totalScore  Int      // Sum of all stan scores

  @@index([fanUserId])
}
